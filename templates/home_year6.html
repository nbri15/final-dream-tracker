{% extends "layout.html" %}
{% block title %}Year 6 Home — Dream Tracker{% endblock %}
{% block content %}
<h1>{{ klass.name }} — Year 6 Home</h1>

<section class="card">
  <form method="get" class="inline" action="{{ url_for('y6_home') }}">
    {% if is_admin %}
      <label>Class<br>
        <select name="class">
          {% for c in classes if c.year_group == 6 %}
            <option value="{{ c.id }}" {{ 'selected' if (selected_class_id|string == c.id|string) else '' }}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </label>
    {% endif %}
    <label>Year<br>
      <select name="year">
        {% for y in years %}
          <option value="{{ y.id }}" {{ 'selected' if y.id == selected_year_id else '' }}>{{ y.label }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Subject block<br>
      <select name="subject">
        <option value="all" {{ 'selected' if filters.subject == 'all' else '' }}>All</option>
        <option value="maths" {{ 'selected' if filters.subject == 'maths' else '' }}>Maths</option>
        <option value="reading" {{ 'selected' if filters.subject == 'reading' else '' }}>Reading</option>
        <option value="spag" {{ 'selected' if filters.subject == 'spag' else '' }}>SPaG</option>
      </select>
    </label>

    <input type="hidden" name="gender" value="{{ filters.gender }}">
    <input type="hidden" name="pp" value="{{ filters.pp }}">
    <input type="hidden" name="laps" value="{{ filters.laps }}">
    <input type="hidden" name="service" value="{{ filters.service }}">

    <button class="button" type="submit">Apply</button>
    <a class="button" href="{{ url_for('y6_home', class=selected_class_id, year=selected_year_id) }}">Clear</a>
  </form>
</section>

<section class="card">
  <form method="get" class="filter-bar">
    {% if selected_class_id %}<input type="hidden" name="class" value="{{ selected_class_id }}">{% endif %}
    {% if selected_year_id %}<input type="hidden" name="year" value="{{ selected_year_id }}">{% endif %}
    <input type="hidden" name="subject" value="{{ filters.subject }}">

    <label>PP
      <select name="pp">
        <option value="all" {{ 'selected' if filters.pp == 'all' else '' }}>All</option>
        <option value="pp" {{ 'selected' if filters.pp == 'pp' else '' }}>PP</option>
        <option value="nonpp" {{ 'selected' if filters.pp == 'nonpp' else '' }}>Non-PP</option>
      </select>
    </label>

    <label>Gender
      <select name="gender">
        <option value="all" {{ 'selected' if filters.gender == 'all' else '' }}>All</option>
        <option value="male" {{ 'selected' if filters.gender == 'male' else '' }}>Male</option>
        <option value="female" {{ 'selected' if filters.gender == 'female' else '' }}>Female</option>
      </select>
    </label>

    <label>LAPs
      <select name="laps">
        <option value="all" {{ 'selected' if filters.laps == 'all' else '' }}>All</option>
        <option value="laps" {{ 'selected' if filters.laps == 'laps' else '' }}>LAPs</option>
        <option value="nonlaps" {{ 'selected' if filters.laps == 'nonlaps' else '' }}>Non-LAPs</option>
      </select>
    </label>

    <label>Service child
      <select name="service">
        <option value="all" {{ 'selected' if filters.service == 'all' else '' }}>All</option>
        <option value="service" {{ 'selected' if filters.service == 'service' else '' }}>Service child</option>
        <option value="nonservice" {{ 'selected' if filters.service == 'nonservice' else '' }}>Non-service child</option>
      </select>
    </label>

    <button class="button" type="submit">Apply</button>
    <a class="button" href="{{ url_for(request.endpoint, class=selected_class_id, year=selected_year_id, subject=filters.subject) }}">Reset</a>
  </form>
</section>

<section class="kpis year6-overview">
  {% for subject_key, title in [('maths','Maths'), ('reading','Reading'), ('spag','SPaG')] %}
    {% if filters.subject in ['all', subject_key] %}
      {% set card = overview[subject_key] %}
      <article class="card">
        <h3>{{ title }}</h3>
        <p><strong>Under (&lt;100):</strong> {{ card.under }}</p>
        <p><strong>At (100–110):</strong> {{ card.at }}</p>
        <p><strong>Above (111+):</strong> {{ card.above }}</p>
        <p><strong>Missing:</strong> {{ card.missing }}</p>
        <p><strong>Total:</strong> {{ card.total }}</p>
      </article>
    {% endif %}
  {% endfor %}
</section>

<section class="card">
  <div class="table-scroll">
    <table class="y6-home-table table-sticky">
      <thead>
        <tr>
          <th rowspan="2">Name</th>
          {% if filters.subject in ['all', 'maths'] %}<th colspan="9">Maths</th>{% endif %}
          {% if filters.subject in ['all', 'reading'] %}<th colspan="9">Reading</th>{% endif %}
          {% if filters.subject in ['all', 'spag'] %}<th colspan="9">SPaG</th>{% endif %}
        </tr>
        <tr>
          {% macro subhead() -%}
            <th class="th-rotate"><div><span>Raw 1</span></div></th>
            <th class="th-rotate"><div><span>Raw 2</span></div></th>
            <th class="th-rotate"><div><span>Raw 3</span></div></th>
            <th class="th-rotate"><div><span>Raw 4</span></div></th>
            <th class="th-rotate"><div><span>Scaled 1</span></div></th>
            <th class="th-rotate"><div><span>Scaled 2</span></div></th>
            <th class="th-rotate"><div><span>Scaled 3</span></div></th>
            <th class="th-rotate"><div><span>Scaled 4</span></div></th>
            <th class="th-rotate"><div><span>Latest Scaled</span></div></th>
          {%- endmacro %}
          {% if filters.subject in ['all', 'maths'] %}{{ subhead() }}{% endif %}
          {% if filters.subject in ['all', 'reading'] %}{{ subhead() }}{% endif %}
          {% if filters.subject in ['all', 'spag'] %}{{ subhead() }}{% endif %}
        </tr>
      </thead>
      <tbody>
        {% if rows %}
          {% for row in rows %}
            <tr>
              <td>
                <div class="y6-name">{{ row.name }}</div>
                <div class="y6-badges">
                  {% if row.badges.PP %}<span class="tiny-badge">PP</span>{% endif %}
                  {% if row.badges.LAP %}<span class="tiny-badge">LAP</span>{% endif %}
                  {% if row.badges.SC %}<span class="tiny-badge">SC</span>{% endif %}
                  {% if row.badges.gender %}<span class="tiny-badge">{{ row.badges.gender }}</span>{% endif %}
                </div>
              </td>

              {% macro subject_cells(data) -%}
                {% for score in data.raw %}<td>{{ score if score is not none else '—' }}</td>{% endfor %}
                {% for score in data.scaled %}<td>{{ score if score is not none else '—' }}</td>{% endfor %}
                <td><span class="score-chip {{ score_class(data.latest_scaled) }}">{{ data.latest_scaled if data.latest_scaled is not none else '—' }}</span></td>
              {%- endmacro %}

              {% if filters.subject in ['all', 'maths'] %}{{ subject_cells(row.maths) }}{% endif %}
              {% if filters.subject in ['all', 'reading'] %}{{ subject_cells(row.reading) }}{% endif %}
              {% if filters.subject in ['all', 'spag'] %}{{ subject_cells(row.spag) }}{% endif %}
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="40" class="center muted">No pupils match the selected filters.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
